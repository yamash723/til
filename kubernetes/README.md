# Kubernetes

## 参考ドキュメント

- [Kubernetesをだいたい理解するまで](https://zenn.dev/gege/articles/80b55c345cc1cb)
- [Kubernetesドキュメント | Kubernetes](https://kubernetes.io/ja/docs/home/)

## Kubernetesとはなんぞや

> Kubernetesは、宣言的な構成管理と自動化を促進し、コンテナ化されたワークロードやサービスを管理するための、ポータブルで拡張性のあるオープンソースのプラットフォームです。Kubernetesは巨大で急速に成長しているエコシステムを備えており、それらのサービス、サポート、ツールは幅広い形で利用可能です。

- コンテナオーケストレーションのデファスタ
- 宣言的なリソース定義を行い。命令的なものとは違って状況の変更に追従しやすい環境の提供
- Googleが社内仮想サーバーのオーケストレーションで使用していたBorgがベースになっている

### Kubernetesが提供するもの

- サービスディスカバリーと負荷分散
  - DNS名または独自のIPアドレスを使ってコンテナを公開可能
  - トラフィックに応じてネットワークトラフィックを分散させることが可能
- ストレージ オーケストレーション
  - ローカルストレージやパブリッククラウドプロバイダーなど、選択したストレージシステムを自動でマウント可能
- 自動化されたロールアウトとロールバック
  - デプロイのためのコンテナ作成、削除など
- 自動ビンパッキング
  - 要件とリソースに基づいてコンテナを自動で配置
- 自己修復
  - 処理に失敗したコンテナの再起動など
- 機密情報と構成管理
  - パスワードやOAuthトークン、SSHキーなどの機密情報を保持、管理できる

## メリット / デメリット

- メリット
  - 障害耐性が高い
  - 可搬性に優れている
    - 各クラウドベンダーがマネージドサービスを提供している
- デメリット
  - K8sの更新サイクルがとても早い
  - 機能が多岐にわたるので学習コストが高い

### Kubernetesマスター

クラスターの望ましい状態を維持することが責務。`kubectl` を使った場合はこのマスターとやり取りしていることになる。

マスターは可用性と冗長性のために複製も可能。

#### コンポーネント

- kube-apiserver: Kubernetes APIを外部に提供するKubernetesコントロールプレーンのコンポーネント（水平スケール可能）
- kube-scheduler: 各Podに対してNodeの割当を行う
- kube-controller-manager
  - ノードコントローラー: ノードがダウンした場合の通知と対応を担当
  - レプリケーションコントローラー: システム内の全レプリケーションコントローラーオブジェクトについて、Podの数を正しく保つ
  - エンドポイントコントローラー: ServiceとPodを紐付ける = エンドポイントオブジェクトを注入します
  - サービスアカウントとトークンコントローラー: 新規の名前空間に対して、デフォルトアカウントとAPIアクセストークンを作成
- etcd: 「あるべき状態」を保持する分散型KVS
- cloud-controller-manager: クラウドサービス特有の制御ロジックを担当
  - ノードコントローラー: ノードが応答を停止した後、クラウドで削除されたかどうかを判断するため、クラウドプロバイダーをチェック
  - ルーティングコントローラー: 基盤であるクラウドインフラでルーティングを設定
  - サービスコントローラー: クラウドプロバイダーのロードバランサーの作成、更新、削除を行う

#### マスターとノード間の通信

- クラスター → マスター
  - `kube-apiserver` のHTTPSエンドポイントへのリクエスト
- マスター → クラスター
  - `kubelet` のHTTPSエンドポイントへのリクエスト
  - もしくはSSHトンネリング ※現在非推奨

### Kubernetesノード

アプリケーションとクラウドワークフローを実行するマシンやVMのこと。アプリケーションのコンポーネントである `Pod` をホストする
運用者は基本このノードと直接やり取りすることはない。

ノー上の `kubelet` がコントロールプレーンに自己登録するか、手動でNodeオブジェクトを登録することでノードを追加することが出来る

#### コンポーネント

- kubelet: Masterと通信
- kube-proxy: 各ノードのKubernetesネットワークサービスを反映するネットワークプロキシ
- コンテナランタイム: コンテナの実行を担当

### リソース

※とりあえずざっと目についたもの

- Pod
  - コンテナ環境
- Deployment
  - Podの管理方法を定義するもの
- DaemonSet
  - クラスタが動作するサーバーごとに1つは起動させるPod
  - メトリクス収集などで使用
- Job
  - 読んで字のごとく常時起動ではない単発処理のPod
- CronJob
  - Jobリソースを定期実行する
- Service
  - 外部やクラスタ内からのアクセスをPodに割り振るネットワーク定義
  - いくつか種類がある
    - ClusterIP (既定値)
      - クラスター内の内部IPでServiceを公開。クラスター内からのみ到達可能
    - NodePort
        - NAT使用。<NodeIP>:<NodePort>でクラスター外部からアクセス可能
        - ClusterIPのスーパーセット
    - LoadBalancer
        - 外部ロードバランサを作成し固定の外部IPを割り当てる
        - NodePortのスーパーセット
    - ExternalName
        - externalNameで指定した名前のCNAMEレコードを返し、任意の名前を使って公開
- Ingress
  - L7スイッチ相当
- ConfigMap
  - Podで使用する設定の定義
- Secret
  - Podで使用する秘匿情報定義
- Volume
  - Podで使用するストレージの定義

CRD（Custom Resource Definition）でユーザーが独自のリソースを定義することも出来る

### CRDの何が嬉しいのか

AWSリソースをTerraform、アプリをK8s、CI/CDをGithubActionsで行う、などバラバラになる場合が多いが、その際にすべてCRDで定義すればK8sマニフェストの世界で完結することができる。

## Tips

- `kubectl` で操作する際、リソース種別を略称で指定できる
  - `kubectl api-resources` で確認可能
- 公式のチートシートがある
  - [kubectlチートシート | Kubernetes](https://kubernetes.io/ja/docs/reference/kubectl/cheatsheet/)


### kubectlプラグイン

- stern
  - 複数Pod / 複数コンテナをtail（Pod単位で色分けしてくれるので可読性Good）
- kube-iexec
  - 実行中PodへexecするときのPodの選択をインタラクティブにしてくれる
- kubectl-view-allocations
  - Nodeや実行中Podのリソース割当を一覧表示
  - 類似に kube-capacity もある
- kubectl-images
  - Podが使用しているImageを一覧表示
- ksniff
  - tcpdump と Wireshark で特定Podのキャプチャを実施
- kubie
  - 複数のシェルで異なるコンテキストを扱える
- kubectl-tree
  - オブジェクト間の所有関係を調べる

### 便利ツール


- K9s
  - クラスタとやりとりするためのターミナルUI
  - popeyeというK8sサニタイザーの結果も出してくれる
- Lens
  - リソースのモニタリング、デプロイをすることが出来るデスクトップアプリ
- kind
  - ローカルクラスタの実行
- minikube
  - ローカルクラスタの実行
